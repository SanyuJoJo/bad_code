# 1.综合类型样本的应急响应
流程：不在做介绍

### 注意事项
**1.office文档本身就是压缩文件，在需要传输文件的时候除了保证office的应用中保存之外，将office压缩包中的文件也要单独保存**
**2.在环境检查和恢复中office类型的恶意样本除了宏还有其他方式也要注意**

宏的查看：
procmon
WINWORD.exe
常见方式一：
伪装成doc文档的exe打开office然后执行其他的
重点内容：
查看进程行为，关注除了WINWORD.EXE之外还有什么东西

常见方式二：
远程模板加载
重点内容：
检查WINWORD.EXE是否存在除了office或者微软相关之外的网络链接

常见方式三：
wwlib劫持
重点内容：
procexp或者火绒即按等工具检查是否存在非office文件安装目录下的wwlib.dll

3.powershell的记录可以在日志管理器中查看到部分内容，结合我们powershell分析的内容综合查看
![[image-2023071208.png]]

**4.不要在已受攻击的机器中调试powershell，代码单独复制出来在安全的环境中复现**

### 清理
将标记的恶意样本及其他相关文件保存之后删除
卸载office重新安装
如果存在office应用账号及时修改密码

正对powershell中的内容目的复原相关内容
修复amsi：
卸载powershell2.0(如果原来是2.0就卸载之后安装4.0)
删除除了：C:/windows/system32/asmi.dll之外的同名文件
关闭并重新开启windowsdefender并打开所有防护功能

打开组策略编辑器
打不开的处理方式：
打开组策略.bat
```
@echo off
pushd "%~dp0"
dir /b %systemroot%\windows\servicing\Packages\Mircrosoft-windows-GroupPolicy-ClientExtensions-Package~3*.mum >gp.txt
dir /b %systemroot%\servicing\Packages\Mircrosoft-windows-GroupPolicy-ClientTools-Package~3*.mum >gp.txt
for /f %%i in ('findstr /i . gp.txt 2^>nul') do dism /online /norestart /add-package:"%systemroot%\servicing\Packages\%%i"
pause
```

![[image-2023071221.png]]

gpedit.msc
![[image-2023071221 1.png]]

![[image-2023071221 2.png]]

![[image-2023071221 3.png]]

# 2.综合类型样本的防御措施
### 1.识别office文件中是否有宏

```
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/><Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme" Target="theme/theme1.xml"/><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/><Relationship Id="rId4" Type="http://schemas.microsoft.com/office/2006/relationships/vbaProject" Target="vbaProject.bin"/></Relationships>
```
出现http://schemas.mircrosoft.com/office/2006/relationships/vbaProject
![[image-2023071222.png]]

![[image-2023071222 1.png]]

![[image-2023071222 2.png]]



### 2.正则与需求
正常office打开的过程-----白名单机制
powershell在正常的业务中的过程------白名单机制

## 防御策略
1.关闭
office宏关闭
如果涉及到自动化办公，不要在办公环境或者换其他方式python

powershell restrict
服务器管理尽量用图形化界面和api
如果要用也不要写脚本，就用原始最基础的运行


2.过滤
设置白名单
	1.思考自身正常业务下的过程
	2.根据需求导入白名单
	3.根据白名单来触发事件

一刀切：
	1.只要带宏的office一律不通过
	2.powershell 除了restricted
3.测试