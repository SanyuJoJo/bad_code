## promon和procexp等工具的使用
1.本地
样本在目标环境下做的行为

环境监视工具：
1.针对单一对象的监视
2.针对整个操作系统的监视

使用方式
1.先打开工具并且设置好
2.启动恶意样本
3.观察

如果是dll：
1.用dependcywalker
2.cmd 命令行
rundll32.exe dll的名字，导出函数的名字 



procexp：
![[./PIC/4.png]]


![[./PIC/5.png]]
主要是用这个工具观察dll和句柄的使用

进程镂空/傀儡进程

processmonitor：
![[./PIC/6.png]]

### 注册表
1.查询
query
在恶意样本分析红存在的场景
1.获得操作系统的信息（语言，时区，用户名等等）
2.RNG随机数
3.获得反沙盒和反病毒信息
4.set设置之后再来使用这个键值
文件

set
1.用户操作
2.开机启动
```
计算机\HKEY_CURRENT_USER\SOFTWARE\Microsoft\windows\CurrentVersion\Run
```

### 文件

%temp%这个是缓存文件夹，如果某个应用释放了pe结构的大小，这里就要格外注意

场景：
1.勒索形式，基本就是对于文件的修改
最重要的特征就是在write之前会循环遍历盘符或者大量文件（在

2.释放其他文件功能模块文件

3.开机启动

```
C:\Users\euweb\AppData\Roaming\Microsoft\Windows\Start_Menu\Programs\Startup
```

4.文件修改 --host

### 进程

进程和线程：
恶意代码分析中，涉及到进程和线程的操作的场景：


释放功能模块（就有可能是shellcode或者是pe）
如果存在进程镂空或者傀儡进程，这个恶意样本会创建一个其他程序的（非dll的）名字的地址和线程

释放：
本来是一个exe
结果变成了2个exe
loadresourceA()
提前知道了有创建线程这样一个操作，那么就要有上面的释放这个过程的心理准备
在我们分析的时候，就去找找createthread这个函数在哪里被交叉引用，再确认一下是否是释放功能

### 权限


### wireshark工具的使用

如果识别不出网卡
1.卸载npcap和wireshark
2.下载一个npcap
3.先安装npcap再重新安装wireshark
4.cmd
```
net start npcap
```

过滤udp的destination port

udp.dstport == 8007
分析--追踪tcp流
统计-->已解析的地址
统计-->协议统计
流量图
网络特征的归纳

方向
进制
while true
	fangwen()
	sleep 5
心跳机制

tcp
持续机制

网络模拟：
dns：样本中有http请求而且这个请求是指向一个域名的
场景：
静态分析的时候发现这个请求是经过加密的，然后你又不想手动解密

a = "asdasds"

a这个变量构造了一个http的请求头或者请求内容
步骤：
1.改测试环境的hosts文件
2.添加目标域名到hosts文件指向一个你可以使用的ip地址
3.指向的ip地址使用一个监听或者嗅探工具
4.

eg：
修改hosts文件
192.168.2.213 tab www.baidu.com

网络上下载一些虚拟网关（网关的虚拟机）

威胁情报平台下载
通常都会有成品的pcap文件
wireshark
tcpdump
dcapy


### 威胁情报平台的使用

搜索引擎
威胁情报平台
社交渠道及平台

国外的情报平台
国内的


### 针对pe结构的恶意代码的应急响应措施
流程：
1.取证
2.分析
3.处理
4.报告

### 注意事项

时间优先，程序合规，要素全面，不要多操作
保存内存状态
dumpit
volalility

程序合规：
如果找到了样本文件，压缩并加密。

要素全面：
截图，记录，记全

不要多操作：

从影响出发
cpu->100% 网页访问卡顿 勒索（对于内容的修改）
|
|
|
什么痕迹造成了这个影响
劫持，拒绝服务，日志(文件修改)
|
|
|
什么操作会动用这个痕迹
网络流量特征分析


### 1.取证
1-1 当前状态
要素：
		进程 
		网络   
		文件
		用户
		性能
		注册表-->工具 regshot
		服务
		宏观
注意事项：
	及时记录
	记录全面
	关系理清

#### 1-2 过去状态
要素：
	日志
	第三方产品

内容：
时间
地点
人物
行为

### 注意事项
时间线非常重要，不同地方的痕迹以时间的关系列出来

### 2.分析
分析到的信息一定要和我们取证中的要素以及时间的关系列出来

### 3.处理
如何利用我们分析的信息做处理：
#### 3-1 进程相关：
找到根进程并结束，如果存在重复启动则需要进一步分析样本中是否对其他线程做操作
#### 3-2网络相关
1.识别到的恶意网络流量以特征字符的识别去拦截
2.关闭正在产生流量的端口和相关进程和服务
3.将目的地址和端口加入黑名单
#### 3-3 文件相关：
以分析到的信息为准删除文件，如果存在删除文件或者文件替换则需要进行还原
在客户允许的前提下尽可能使用覆写删除的方式
#### 3-4用户相关：
以分析到的信息为准对用户做操作
涉及到用户的所有操作必须对客户必须对客户提前说明尽可能要求客户提供时间前的用户列表
#### 3-5注册表相关：
以分析到的信息为准对注册表做操作
#### 3-6 服务相关
以分析到的信息为准对服务做操作
#### 3-7 漏洞相关
如果样本中存在漏洞利用则需要修复相应漏洞并提前测试
如果存在未知漏洞利用则需要进一步记录并向相关机构和厂商提供信息

#### 3-8 专杀相关
如果需要提供专杀工具则需要向客户说明工具授权，如果是开源工具则需要说明开源协议

### 4.报告：
4-1 取证中的要素要和分析的信息一一对应
4-2 取证、分析、处理的全过程必须---截图，并且处理完成之后有记录
4-3 样本的全流程要有att&ck的表
4-4 注意自己的法律风险并标注好相关信息
4-5 编译时间、编译工具、ttps(代码风格)、loc尽可能写出来，并金肯判断出攻击关联
附：文件hash查看

### 针对pe结构的恶意代码的防护提升措施
#### 思路
所有防护措施以业务为最高优先级，在结合自己的安全策略，对当前样本中涉及到的关键点做补充

常见关键点
1.权限与逻辑
2.业务与攻击面
3.数据与传输
4.意识与管理

关键点的收集：
1.钓鱼过程
1-1 钓鱼的话术与场景设置：
			文化的熟悉程度
			具体信息的熟悉程度
1-2 钓鱼的渠道：
	具体产品的薄弱点
1-3 被钓鱼的意识：
	管理结构
	权限结构
	安全意识培训

2.入侵过程
2-1 入侵面积
先确定及其-->再确定机器所属安全范围--->
攻击面与边缘产品的布置
2-2 入侵的点：
产品的更新与检查
2-3 入侵的路径
内部产品的布置与网络结构的调整

3.时间与空间
3-1 与同行沟通共享信息并获得攻击上的行业规律
3-2 域名和网络流量分析攻击来源并获得攻击上的地区
3-3 时间点分析攻击频率和时间节点并在威胁情报中收集规律
3-4 将收集到的攻击规律与业务相结合优化自己的安全策略
3-5 将收集到的攻击规律结合威胁情报优化自己的威胁情报收集系统